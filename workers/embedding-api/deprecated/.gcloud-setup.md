# GCP CLI Setup Report

**Date**: 2025-12-14
**Agent**: DevOps Engineer
**Working Directory**: /home/devuser/workspace/fairfield-nostr/workers/embedding-api

## Current Status

### ✅ Installation
- **gcloud CLI Version**: 549.0.1
- **Installation Path**: `/home/devuser/google-cloud-sdk/bin/gcloud`
- **Python Version**: 3.13.7
- **Components**: bq, bundled-python3-unix, core, gcloud-crc32c, gsutil

### ❌ Authentication
- **Status**: NOT AUTHENTICATED
- **Active Account**: None
- **Active Project**: None

## Required Credentials

The provided API key `AIzaSyDECKrECyKMqdNbGiSAkHvxqFt5sxUveqM` appears to be a Google API key (not GCP authentication credentials).

### Authentication Options

#### Option 1: Service Account (Recommended for CI/CD)
```bash
# Export environment variables
export PATH="/home/devuser/google-cloud-sdk/bin:$PATH"
export CLOUDSDK_PYTHON=python3

# Authenticate with service account JSON
gcloud auth activate-service-account --key-file=/path/to/service-account-key.json

# Set project
gcloud config set project YOUR_PROJECT_ID
```

**Required**: Service account JSON key file with permissions:
- Cloud Run Admin
- Cloud Storage Admin
- Artifact Registry Admin
- Cloud Build Editor

#### Option 2: User Account (Interactive)
```bash
# Export environment variables
export PATH="/home/devuser/google-cloud-sdk/bin:$PATH"
export CLOUDSDK_PYTHON=python3

# Login interactively (requires browser)
gcloud auth login

# Set project
gcloud config set project YOUR_PROJECT_ID
```

#### Option 3: Application Default Credentials
```bash
# Set ADC to use a service account
export GOOGLE_APPLICATION_CREDENTIALS=/path/to/service-account-key.json

# Verify
gcloud auth application-default print-access-token
```

## Environment Setup Script

Create `/home/devuser/.gcloud-env`:

```bash
#!/bin/bash
# GCP Environment Setup

export PATH="/home/devuser/google-cloud-sdk/bin:$PATH"
export CLOUDSDK_PYTHON=python3

# Uncomment and set when credentials are available:
# export GOOGLE_APPLICATION_CREDENTIALS=/path/to/service-account.json
# export GOOGLE_CLOUD_PROJECT=your-project-id
```

Source in your shell:
```bash
source /home/devuser/.gcloud-env
```

## Post-Authentication Setup

Once authenticated, run these commands to complete setup:

### 1. Verify Authentication
```bash
gcloud auth list
gcloud config list
```

### 2. List/Create Projects
```bash
# List available projects
gcloud projects list

# Create new project (if needed)
gcloud projects create minimoonoir-nostr --name="MiniMoNoiR Nostr"
gcloud config set project minimoonoir-nostr
```

### 3. Enable Required APIs
```bash
gcloud services enable \
  run.googleapis.com \
  storage.googleapis.com \
  artifactregistry.googleapis.com \
  cloudbuild.googleapis.com \
  compute.googleapis.com
```

### 4. Create Storage Bucket
```bash
# Create bucket for embeddings
gsutil mb -p minimoonoir-nostr -l us-central1 gs://minimoonoir-vectors/

# Set lifecycle policy (optional)
cat > lifecycle.json <<EOF
{
  "lifecycle": {
    "rule": [
      {
        "action": {"type": "Delete"},
        "condition": {"age": 365}
      }
    ]
  }
}
EOF
gsutil lifecycle set lifecycle.json gs://minimoonoir-vectors/

# Set CORS (if needed for web access)
cat > cors.json <<EOF
[
  {
    "origin": ["*"],
    "method": ["GET", "HEAD"],
    "responseHeader": ["Content-Type"],
    "maxAgeSeconds": 3600
  }
]
EOF
gsutil cors set cors.json gs://minimoonoir-vectors/
```

### 5. Create Artifact Registry
```bash
# Create Docker repository
gcloud artifacts repositories create embedding-api \
  --repository-format=docker \
  --location=us-central1 \
  --description="Embedding API container images"

# Configure Docker auth
gcloud auth configure-docker us-central1-docker.pkg.dev
```

### 6. Setup Cloud Run
```bash
# Deploy service (example)
gcloud run deploy embedding-api \
  --image=us-central1-docker.pkg.dev/minimoonoir-nostr/embedding-api/api:latest \
  --region=us-central1 \
  --platform=managed \
  --allow-unauthenticated \
  --set-env-vars="GOOGLE_CLOUD_PROJECT=minimoonoir-nostr,BUCKET_NAME=minimoonoir-vectors"
```

## Credentials Needed

**BLOCKING ISSUE**: Cannot proceed without one of the following:

1. **Service Account JSON Key** (preferred)
   - Download from GCP Console: IAM & Admin > Service Accounts
   - Required roles: Cloud Run Admin, Storage Admin, Artifact Registry Admin

2. **User Account with Owner/Editor Role**
   - Run `gcloud auth login` (requires browser access)
   - Needs permissions to create/manage resources

3. **Existing GCP Project ID**
   - If project exists: provide project ID
   - If not: need permission to create project

## Notes

- **Cloudflare Account ID** (`ccdf454d3f62f5a2f82350c65bac1052`) is not related to GCP authentication
- **API Key** (`AIzaSyDECKrECyKMqdNbGiSAkHvxqFt5sxUveqM`) may be for Google Maps/Firebase, not GCP auth
- GCP uses OAuth2, Service Accounts, or ADC for authentication
- API keys alone cannot authenticate gcloud CLI

## Next Steps

1. Obtain GCP service account credentials or user account access
2. Run authentication commands from Option 1 or 2 above
3. Execute post-authentication setup commands
4. Verify all APIs are enabled
5. Test bucket access: `gsutil ls gs://minimoonoir-vectors/`

## Quick Reference

```bash
# Add to ~/.bashrc or ~/.zshrc
export PATH="/home/devuser/google-cloud-sdk/bin:$PATH"
export CLOUDSDK_PYTHON=python3

# Verify setup
gcloud version
gcloud auth list
gcloud config list
gcloud projects list
```
