name: Deploy Nostr Relay to GCP Cloud Run

on:
  push:
    branches:
      - main
    paths:
      - 'services/nostr-relay/**'
      - 'nosflare/**'
      - '.github/workflows/deploy-nostr-relay.yml'
  pull_request:
    branches:
      - main
    paths:
      - 'services/nostr-relay/**'
      - 'nosflare/**'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

env:
  PROJECT_ID: ${{ secrets.GOOGLE_CLOUD_PROJECT }}
  REGION: us-central1
  SERVICE_NAME: nostr-relay
  REGISTRY: gcr.io

jobs:
  # Job 1: Lint and test
  test:
    name: Test and Lint
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm ci
          cd nosflare && npm ci

      - name: Run linter
        run: npm run lint

      - name: Run type check
        run: npm run typecheck

      - name: Run unit tests
        run: npm test

  # Job 2: Build and deploy
  deploy:
    name: Build and Deploy
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    needs: []

    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      # Authenticate to Google Cloud using Workload Identity Federation
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}

      # Alternative: Use service account key (less secure)
      # - name: Authenticate to Google Cloud (Key)
      #   uses: google-github-actions/auth@v2
      #   with:
      #     credentials_json: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for GCR
        run: gcloud auth configure-docker

      - name: Extract metadata
        id: meta
        run: |
          echo "sha_short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          echo "build_date=$(date -u +'%Y-%m-%dT%H:%M:%SZ')" >> $GITHUB_OUTPUT
          echo "version=$(cat package.json | jq -r .version)" >> $GITHUB_OUTPUT

      # Build using Cloud Build (recommended for production)
      - name: Submit build to Cloud Build
        run: |
          gcloud builds submit \
            --config=services/nostr-relay/cloudbuild.yaml \
            --substitutions=COMMIT_SHA=${{ steps.meta.outputs.sha_short }},_REGION=${{ env.REGION }} \
            --project=${{ env.PROJECT_ID }}

      # Alternative: Build locally and push
      # - name: Build Docker image
      #   run: |
      #     docker build \
      #       -t ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.SERVICE_NAME }}:${{ steps.meta.outputs.sha_short }} \
      #       -t ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.SERVICE_NAME }}:latest \
      #       -f services/nostr-relay/Dockerfile \
      #       --build-arg VERSION=${{ steps.meta.outputs.version }} \
      #       --build-arg BUILD_DATE=${{ steps.meta.outputs.build_date }} \
      #       --build-arg VCS_REF=${{ github.sha }} \
      #       .
      #
      # - name: Push Docker image
      #   run: |
      #     docker push ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.SERVICE_NAME }}:${{ steps.meta.outputs.sha_short }}
      #     docker push ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.SERVICE_NAME }}:latest

      - name: Deploy to Cloud Run
        run: |
          gcloud run deploy ${{ env.SERVICE_NAME }} \
            --image=${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.SERVICE_NAME }}:${{ steps.meta.outputs.sha_short }} \
            --region=${{ env.REGION }} \
            --platform=managed \
            --allow-unauthenticated \
            --service-account=nostr-relay@${{ env.PROJECT_ID }}.iam.gserviceaccount.com \
            --use-http2 \
            --session-affinity \
            --timeout=3600 \
            --min-instances=1 \
            --max-instances=3 \
            --concurrency=80 \
            --cpu=1 \
            --memory=512Mi \
            --set-env-vars="NODE_ENV=production,RELAY_NAME=Fairfield Nostr Relay" \
            --add-cloudsql-instances=${{ env.PROJECT_ID }}:${{ env.REGION }}:nostr-db \
            --set-secrets=DATABASE_URL=nostr-db-url:latest,ADMIN_PUBKEY=admin-pubkey:latest \
            --labels=app=${{ env.SERVICE_NAME }},env=production,version=${{ steps.meta.outputs.version }}

      - name: Get service URL
        id: service-url
        run: |
          URL=$(gcloud run services describe ${{ env.SERVICE_NAME }} \
            --region=${{ env.REGION }} \
            --format='value(status.url)')
          echo "url=$URL" >> $GITHUB_OUTPUT
          echo "Service URL: $URL"

      - name: Test deployment
        run: |
          # Wait for service to be ready
          sleep 30

          # Test health endpoint
          curl -f -s ${{ steps.service-url.outputs.url }}/health || exit 1

          # Test WebSocket upgrade (expect 426 Upgrade Required or connection)
          curl -i -N -H "Connection: Upgrade" \
               -H "Upgrade: websocket" \
               -H "Sec-WebSocket-Version: 13" \
               -H "Sec-WebSocket-Key: SGVsbG8sIHdvcmxkIQ==" \
               ${{ steps.service-url.outputs.url }} || echo "WebSocket test completed"

      - name: Create deployment summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## Deployment Successful ðŸš€

          **Service:** ${{ env.SERVICE_NAME }}
          **Region:** ${{ env.REGION }}
          **Version:** ${{ steps.meta.outputs.version }}
          **Commit:** ${{ steps.meta.outputs.sha_short }}

          **Service URL:** ${{ steps.service-url.outputs.url }}

          ### Configuration
          - Min Instances: 1 (persistent WebSocket)
          - Max Instances: 3 (free tier optimized)
          - Timeout: 3600s (1 hour)
          - Memory: 512Mi
          - CPU: 1

          ### Next Steps
          1. Update VITE_RELAY_URL in .env to: \`${{ steps.service-url.outputs.url }}\`
          2. Test WebSocket connection from client
          3. Monitor logs: \`gcloud run logs read ${{ env.SERVICE_NAME }} --region=${{ env.REGION }}\`
          EOF

  # Job 3: Smoke tests
  smoke-test:
    name: Smoke Tests
    runs-on: ubuntu-latest
    needs: deploy
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}

      - name: Get service URL
        id: service-url
        run: |
          URL=$(gcloud run services describe ${{ env.SERVICE_NAME }} \
            --region=${{ env.REGION }} \
            --format='value(status.url)')
          echo "url=$URL" >> $GITHUB_OUTPUT

      - name: Install dependencies
        run: npm ci

      - name: Run smoke tests
        env:
          RELAY_URL: ${{ steps.service-url.outputs.url }}
        run: |
          npm run test:integration -- --grep "smoke"
