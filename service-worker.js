const i=self.__WB_MANIFEST,l="v1",f=`minimoomaa-noir-static-${l}`,w=`minimoomaa-noir-dynamic-${l}`,m=`minimoomaa-noir-profiles-${l}`,g=(i==null?void 0:i.length)>0?i.map(e=>e.url):["/","/index.html","/manifest.json","/favicon.ico"],p="minimoomaa-noir-queue",r="outgoing-messages",y=1;async function u(){return new Promise((e,t)=>{const s=indexedDB.open(p,y);s.onerror=()=>t(s.error),s.onsuccess=()=>e(s.result),s.onupgradeneeded=n=>{const a=n.target.result;a.objectStoreNames.contains(r)||a.createObjectStore(r,{keyPath:"id"}).createIndex("timestamp","timestamp",{unique:!1})}})}async function E(e){const t=await u();return new Promise((s,n)=>{const c=t.transaction([r],"readwrite").objectStore(r).add(e);c.onsuccess=()=>s(),c.onerror=()=>n(c.error)})}async function h(){const e=await u();return new Promise((t,s)=>{const o=e.transaction([r],"readonly").objectStore(r).getAll();o.onsuccess=()=>t(o.result),o.onerror=()=>s(o.error)})}async function S(e){const t=await u();return new Promise((s,n)=>{const c=t.transaction([r],"readwrite").objectStore(r).delete(e);c.onsuccess=()=>s(),c.onerror=()=>n(c.error)})}async function W(){const e=await u();return new Promise((t,s)=>{const o=e.transaction([r],"readwrite").objectStore(r).clear();o.onsuccess=()=>t(),o.onerror=()=>s(o.error)})}self.addEventListener("install",e=>{console.log("[SW] Installing service worker..."),e.waitUntil((async()=>{await(await caches.open(f)).addAll(g),await self.skipWaiting()})())});self.addEventListener("activate",e=>{console.log("[SW] Activating service worker..."),e.waitUntil((async()=>{const t=await caches.keys();await Promise.all(t.filter(s=>s.startsWith("minimoomaa-noir-")&&!s.includes(l)).map(s=>caches.delete(s))),await self.clients.claim()})())});function k(e){const t=e.pathname;return e.protocol==="wss:"||e.protocol==="ws:"?"network-only":t.endsWith(".js")||t.endsWith(".css")||t.endsWith(".html")||t.endsWith(".ico")||t.endsWith(".png")||t.endsWith(".jpg")||t.endsWith(".svg")||t.endsWith(".woff2")||t.endsWith(".woff")||t.endsWith(".ttf")?"cache-first":t.includes("/avatar")||t.includes("/profile")||t.includes("/metadata")?"stale-while-revalidate":"network-first"}async function b(e,t){const s=await caches.match(e);if(s)return s;try{const n=await fetch(e);return n.ok&&(await caches.open(t)).put(e,n.clone()),n}catch(n){return console.error("[SW] Cache-first fetch failed:",n),new Response("Offline",{status:503})}}async function A(e,t){try{const s=await fetch(e);return s.ok&&(await caches.open(t)).put(e,s.clone()),s}catch{console.log("[SW] Network failed, trying cache...");const n=await caches.match(e);return n||new Response("Offline",{status:503})}}async function C(e,t){const s=await caches.match(e),n=fetch(e).then(a=>(a.ok&&caches.open(t).then(c=>c.put(e,a.clone())),a)).catch(()=>s||new Response("Offline",{status:503}));return s||n}self.addEventListener("fetch",e=>{const t=new URL(e.request.url),s=k(t);s!=="network-only"&&e.respondWith((async()=>{switch(s){case"cache-first":return b(e.request,f);case"network-first":return A(e.request,w);case"stale-while-revalidate":return C(e.request,m);default:return fetch(e.request)}})())});self.addEventListener("sync",e=>{const t=e;t.tag==="sync-messages"&&t.waitUntil((async()=>{console.log("[SW] Background sync triggered");try{const s=await h();for(const a of s)try{(await Promise.allSettled(a.relayUrls.map(d=>fetch(d,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(["EVENT",a.event])})))).some(d=>d.status==="fulfilled")&&await S(a.id)}catch(o){console.error("[SW] Failed to sync message:",o)}(await self.clients.matchAll()).forEach(a=>{a.postMessage({type:"SYNC_COMPLETE",count:s.length})})}catch(s){console.error("[SW] Background sync failed:",s)}})())});self.addEventListener("message",e=>{const{type:t,payload:s}=e.data;switch(t){case"QUEUE_MESSAGE":E(s).then(()=>{var n;(n=e.ports[0])==null||n.postMessage({success:!0})}).catch(n=>{var a;(a=e.ports[0])==null||a.postMessage({success:!1,error:n.message})});break;case"GET_QUEUE":h().then(n=>{var a;(a=e.ports[0])==null||a.postMessage({messages:n})}).catch(n=>{var a;(a=e.ports[0])==null||a.postMessage({error:n.message})});break;case"CLEAR_QUEUE":W().then(()=>{var n;(n=e.ports[0])==null||n.postMessage({success:!0})}).catch(n=>{var a;(a=e.ports[0])==null||a.postMessage({success:!1,error:n.message})});break;case"SKIP_WAITING":self.skipWaiting();break}});self.addEventListener("push",e=>{if(!e.data)return;const t=e.data.json();e.waitUntil(self.registration.showNotification(t.title,{body:t.body,icon:"/icon-192x192.png",badge:"/icon-192x192.png",tag:t.tag||"minimoomaa-noir",data:t.url}))});self.addEventListener("notificationclick",e=>{e.notification.close(),e.waitUntil(self.clients.matchAll({type:"window"}).then(t=>{const s=e.notification.data||"/";for(const n of t)if(n.url===s&&"focus"in n)return n.focus();if(self.clients.openWindow)return self.clients.openWindow(s)}))});console.log("[SW] Service worker loaded");
